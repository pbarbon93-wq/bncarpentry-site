<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BN Carpentry – Admin (GitHub Direct)</title>
  <meta name="description" content="Edit BN Carpentry content files directly on GitHub using a personal access token. No eval, CSP-safe." />
  <style>
    :root { --brand:#0a5ef3; --ink:#0f172a; --bg:#f6f7fb; --card:#ffffff; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0a5ef3,#094ed0);color:#fff;padding:18px 16px;box-shadow:0 6px 20px rgba(10,94,243,.25)}
    header .wrap{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:14px}
    header h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
    main{max-width:980px;margin:24px auto;padding:0 16px 40px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:18px 16px;margin-bottom:18px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=password],textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font:inherit}
    textarea{min-height:240px;tab-size:2;white-space:pre;overflow:auto}
    button{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    button.ghost{background:#eef2ff;color:#1e40af}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .ok{color:#15803d;font-weight:600}
    .err{color:#b91c1c;font-weight:600;white-space:pre-wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .footer{margin-top:20px;font-size:12px;color:var(--muted)}
    .badge{display:inline-block;background:#ecfdf5;color:#059669;border-radius:999px;padding:4px 8px;font-size:11px;font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>BN Carpentry — Admin</h1>
      <span class="badge">GitHub Direct · CSP‑Safe</span>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <div class="col">
          <label>GitHub Personal Access Token (fine‑grained, repo: <span class="mono">bncarpentry-site</span>)</label>
          <input id="token" type="password" placeholder="ghp_..." autocomplete="off" />
          <div class="hint">Create at <b>github.com/settings/tokens</b> → Fine‑grained → Repo access: <b>bncarpentry-site</b> → Permissions: <b>Contents: Read & Write</b>. Token stays only in your browser memory.</div>
        </div>
        <div class="col">
          <label>Repository (owner/name)</label>
          <input id="repo" type="text" value="pbarbon93-wq/bncarpentry-site" />
        </div>
        <div class="col">
          <label>Branch</label>
          <input id="branch" type="text" value="main" />
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button id="btnLoad">Load Content</button>
        <button id="btnSaveAll" class="ghost">Save All Changes</button>
        <span id="status" class="hint"></span>
      </div>
    </div>

    <div class="card">
      <h3>site.json</h3>
      <textarea id="siteJson" spellcheck="false"></textarea>
      <div class="toolbar" style="margin-top:10px">
        <button data-file="content/site.json" class="btnSave">Save site.json</button>
        <span class="hint">Path: <span class="mono">content/site.json</span></span>
      </div>
    </div>

    <div class="card">
      <h3>services.json</h3>
      <textarea id="servicesJson" spellcheck="false"></textarea>
      <div class="toolbar" style="margin-top:10px">
        <button data-file="content/services.json" class="btnSave">Save services.json</button>
        <span class="hint">Path: <span class="mono">content/services.json</span></span>
      </div>
    </div>

    <div class="card">
      <h3>gallery.json</h3>
      <textarea id="galleryJson" spellcheck="false"></textarea>
      <div class="toolbar" style="margin-top:10px">
        <button data-file="content/gallery.json" class="btnSave">Save gallery.json</button>
        <span class="hint">Path: <span class="mono">content/gallery.json</span></span>
      </div>
    </div>

    <div class="footer">
      Tip: add images via GitHub “Upload files” to <span class="mono">/images/</span> then reference them in <span class="mono">gallery.json</span>.
    </div>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);
    const status = $("#status");
    const enc = s => btoa(unescape(encodeURIComponent(s)));
    const dec = s => decodeURIComponent(escape(atob(s)));

    async function gh(path, { method="GET", token, body }={}) {
      const repo = $("#repo").value.trim();
      const res = await fetch(`https://api.github.com/repos/${repo}/${path}`, {
        method,
        headers: {
          "Accept": "application/vnd.github+json",
          "Authorization": token ? `Bearer ${token}` : undefined
        },
        body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}\n${await res.text()}`);
      return res.json();
    }

    async function loadFile(path) {
      const token = $("#token").value.trim();
      const data = await gh(`contents/${path}?ref=${$("#branch").value.trim()}`, { token });
      const content = dec(data.content);
      return { text: content, sha: data.sha };
    }

    async function saveFile(path, text, sha) {
      const token = $("#token").value.trim();
      const branch = $("#branch").value.trim();
      const message = `chore(admin): update ${path}`;
      const body = { message, content: enc(text), branch, sha };
      const data = await gh(`contents/${path}`, { method:"PUT", token, body });
      return data.content.sha;
    }

    async function loadAll() {
      try {
        status.textContent = "Loading...";
        const site = await loadFile("content/site.json");
        const services = await loadFile("content/services.json");
        const gallery = await loadFile("content/gallery.json");
        $("#siteJson").value = site.text;
        $("#servicesJson").value = services.text;
        $("#galleryJson").value = gallery.text;
        $("#siteJson").dataset.sha = site.sha;
        $("#servicesJson").dataset.sha = services.sha;
        $("#galleryJson").dataset.sha = gallery.sha;
        status.innerHTML = "<span class='ok'>Loaded ✓</span>";
      } catch (e) {
        status.innerHTML = "<span class='err'>"+e.message+"</span>";
      }
    }

    async function saveOne(textarea, path) {
      try {
        const newSha = await saveFile(path, textarea.value, textarea.dataset.sha);
        textarea.dataset.sha = newSha;
        status.innerHTML = "<span class='ok'>Saved "+path+" ✓</span>";
      } catch (e) {
        status.innerHTML = "<span class='err'>"+e.message+"</span>";
      }
    }

    $("#btnLoad").addEventListener("click", loadAll);
    $("#btnSaveAll").addEventListener("click", async () => {
      await saveOne($("#siteJson"), "content/site.json");
      await saveOne($("#servicesJson"), "content/services.json");
      await saveOne($("#galleryJson"), "content/gallery.json");
    });
    document.querySelectorAll(".btnSave").forEach(btn => {
      btn.addEventListener("click", () => {
        const path = btn.getAttribute("data-file");
        const ta = path.includes("site") ? $("#siteJson") : path.includes("services") ? $("#servicesJson") : $("#galleryJson");
        saveOne(ta, path);
      });
    });
  </script>
</body>
</html>
