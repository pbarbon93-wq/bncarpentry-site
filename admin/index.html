<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BN Carpentry — Full Visual Admin</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: https:;
                 connect-src 'self' https://api.github.com;
                 font-src 'self';
                 frame-ancestors 'none';">

  <style>
    body{font-family:system-ui, sans-serif;margin:0;background:#f6f7fb;color:#0f172a;}
    header{background:#0a5ef3;color:#fff;padding:14px 16px;box-shadow:0 4px 12px rgba(0,0,0,.15);}
    h1{margin:0;font-size:18px;}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:flex;flex-direction:column;gap:16px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,.06);padding:16px;}
    label{display:block;font-size:12px;color:#555;margin-bottom:4px;}
    input,textarea{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:8px;font:inherit;}
    textarea{min-height:100px;}
    button{background:#0a5ef3;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:600;}
    .ghost{background:#eef2ff;color:#1e40af;}
    .toolbar{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
    .ok{color:green;font-weight:700;}
    .err{color:red;font-weight:700;white-space:pre-wrap;}
    .kv{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;}
    pre{background:#111;color:#0f0;padding:10px;border-radius:10px;max-height:300px;overflow:auto;}
  </style>
</head>
<body>
<header><h1>BN Carpentry — Full Visual Admin</h1></header>

<main>
  <section class="card">
    <div class="toolbar">
      <input id="token" type="password" placeholder="GitHub Token (ghp_...)" style="flex:1">
      <input id="repo" type="text" value="pbarbon93-wq/bncarpentry-site" style="flex:1">
      <button id="btnLoad">Load Content</button>
      <button id="btnSaveAll" class="ghost">Save All</button>
      <span id="status"></span>
    </div>
  </section>

  <section class="card">
    <h3>Site Basics</h3>
    <div class="kv">
      <div><label>Brand name</label><input id="brand_name" type="text"></div>
      <div><label>Hero title</label><input id="hero_title" type="text"></div>
      <div><label>Hero subtitle</label><input id="hero_subtitle" type="text"></div>
      <div><label>About text</label><textarea id="about_text"></textarea></div>
      <div><label>Background image (hero)</label><input id="background_image" type="text" placeholder="images/bg-hero.jpg"></div>
      <div><label>Logo image</label><input id="logo_image" type="text" placeholder="images/logo.png"></div>
      <div><label>Primary color</label><input id="primary_color" type="text" placeholder="#0a5ef3"></div>
      <div><label>Footer text</label><input id="footer_text" type="text" placeholder="© 2025 BN Carpentry"></div>
    </div>
  </section>

  <section class="card">
    <h3>Contact & Socials</h3>
    <div class="kv">
      <div><label>Location</label><input id="location" type="text"></div>
      <div><label>Phone display</label><input id="phone_display" type="text"></div>
      <div><label>Phone WhatsApp</label><input id="phone_whatsapp" type="text"></div>
      <div><label>Email</label><input id="email" type="email"></div>
      <div><label>Facebook</label><input id="facebook" type="url"></div>
      <div><label>Instagram</label><input id="instagram" type="url"></div>
      <div><label>WhatsApp link</label><input id="whatsapp" type="url"></div>
    </div>
  </section>

  <section class="card">
    <h3>Preview JSON</h3>
    <pre id="preview">{}</pre>
  </section>
</main>

<script>
const $ = s => document.querySelector(s);
const enc = s => btoa(unescape(encodeURIComponent(s)));
const dec = s => decodeURIComponent(escape(atob(s)));
const statusEl = $("#status");
let shaSite = "", site = {};

async function gh(path,{method="GET",token,body}={}) {
  const repo=$("#repo").value.trim();
  const url=`https://api.github.com/repos/${repo}/${path}`;
  const res=await fetch(url,{method,headers:{
    "Accept":"application/vnd.github+json",
    "Authorization":token?`Bearer ${token}`:undefined,
    "X-GitHub-Api-Version":"2022-11-28"
  },body:body?JSON.stringify(body):undefined});
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}\n${await res.text()}`);
  return res.json();
}

async function loadSite(){
  try{
    statusEl.textContent="Loading...";
    const token=$("#token").value.trim();
    const data=await gh(`contents/content/site.json?ref=main`,{token});
    site=JSON.parse(dec(data.content));
    shaSite=data.sha;
    for(const k in site){if($("#"+k))$("#"+k).value=site[k];}
    updatePreview();
    statusEl.innerHTML="<span class='ok'>Loaded ✓</span>";
  }catch(e){
    statusEl.innerHTML="<span class='err'>"+e.message+"</span>";
  }
}

async function saveSite(){
  try{
    statusEl.textContent="Saving...";

    // --- Segurança: remove campos sensíveis e tokens ---
    if(site.token) delete site.token;
    if(site.repo) delete site.repo;
    if(site.branch) delete site.branch;

    // Detecção de padrões de segredo (ghp_, gho_, etc.)
    const jsonStr = JSON.stringify(site);
    if (/gh[pso]_[A-Za-z0-9]{20,}/.test(jsonStr)) {
      throw new Error("⚠️ Secret-like value detected in content. Remove any token before saving.");
    }

    // --- Tentativa de salvar, com recarga automática de SHA se der 409 ---
    const token=$("#token").value.trim();
    const body={message:"update site.json",content:enc(JSON.stringify(site,null,2)),branch:"main",sha:shaSite};
    try {
      const res=await gh(`contents/content/site.json`,{method:"PUT",token,body});
      shaSite=res.content.sha;
    } catch(err) {
      if(err.message.includes("409")) {
        statusEl.textContent="Conflict detected, reloading SHA...";
        const reload=await gh(`contents/content/site.json?ref=main`,{token});
        shaSite=reload.sha;
        const retry=await gh(`contents/content/site.json`,{method:"PUT",token,body});
        shaSite=retry.content.sha;
      } else throw err;
    }

    updatePreview();
    statusEl.innerHTML="<span class='ok'>Saved ✓</span>";
  }catch(e){
    console.error("Save error:", e);
    statusEl.innerHTML="<span class='err'>"+(e.message || "Failed to save").replace(/\n/g, ' • ')+"</span>";
  }
}

function updatePreview(){ $("#preview").textContent=JSON.stringify(site,null,2); }

$("#btnLoad").addEventListener("click",loadSite);
$("#btnSaveAll").addEventListener("click",saveSite);
</script>
</body>
</html>
